<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kameratracking RollB</title>

    <script src="tracking-min.js"></script>
    <script src="stats.min.js"></script>

    <style>
        video, canvas {
            margin-left: 0px;
            margin-top: 0px;
            position: absolute;
        }
    </style>
</head>
<body>


<div class="demo-frame">
    <div class="demo-container">
        <video id="video" width="1000" height="850" preload autoplay loop muted controls></video>
        <canvas id="canvas" width="1000" height="850"></canvas>
    </div>
</div>

<script>
    window.onload = function () {
        var video = document.getElementById('video');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var middle = canvas.getContext('2d');
        var rahmen = canvas.getContext('2d');
        var ziel = canvas.getContext('2d');


        tracking.ColorTracker.registerColor('green', function (r, g, b) {
            return (r < 50 && g > 200 && b < 50);
        });

        tracking.ColorTracker.registerColor('blue', function (r, g, b) {
            return (r < 50 && g < 50 && b > 200);

        });

        tracking.ColorTracker.registerColor('white', function (r, g, b) {
            return (r > 240 && g > 240 && b > 240)
        });

        tracking.ColorTracker.registerColor('grey', function (r, g, b) {
            return (r > 200 && g > 200 && b > 200);

        });

        var tracker = new tracking.ColorTracker(["yellow", "grey"]);

        tracking.track('#video', tracker, {camera: true});

        var movingTargetX;

        var movingTargetY;

        function track(rect) {

            if (rect.color === "grey") {
                var rollBX = rect.x + rect.width / 2;
                var rollBY = rect.y + rect.height / 2;
            }

            if (rect.color === "yellow") {
                movingTargetX = rect.x + rect.width / 2;
                movingTargetY = rect.y + rect.height / 2;
            }

            context.strokeStyle = rect.color;
            context.strokeRect(rect.x, rect.y, rect.width, rect.height);
            context.font = '40px Helvetica';
            context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
            context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 40);

            middle.fillRect(rollBX, rollBY, 10, 10);

            sendGetRequest("/movementRollB/" + rollBX + "/" + rollBY);
            sendGetRequest("/movementGoal/" + movingTargetX + "/" + movingTargetY);

        }

        tracker.on('track', function (event) {
                context.clearRect(0, 0, canvas.width, canvas.height);

                rahmen.strokeStyle = "#ff0000";
                rahmen.strokeRect(100, 150, 800, 550);

                ziel.strokeStyle = "#ff0000";
                ziel.fillRect(400, 400, 10, 10);

                if (event.data.length === 0) {
                    sendGetRequest("/movement/outOfBorder");
                } else {
                    event.data.forEach(track);
                }
            }
        )
        ;
    }
    ;


    function sendGetRequest(url) {

        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
        };
        xmlhttp.open("GET", url, true);
        xmlhttp.send();

    }


</script>

</body>
</html>
