<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kameratracking RollB</title>

    <script src="tracking-min.js"></script>
    <script src="stats.min.js"></script>

    <style>
        video, canvas {
            margin-left: 0px;
            margin-top: 0px;
            position: absolute;
        }
    </style>
</head>
<body>


<div class="demo-frame">
    <div class="demo-container">
        <video id="video" width="1000" height="850" preload autoplay loop muted controls></video>
        <canvas id="canvas" width="1000" height="850"></canvas>
    </div>
</div>

<script>
    window.onload = function () {
        var video = document.getElementById('video');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var middle = canvas.getContext('2d');
        var rahmen = canvas.getContext('2d');
        var ziel = canvas.getContext('2d');


        tracking.ColorTracker.registerColor('green', function (r, g, b) {
            if (r < 50 && g > 200 && b < 50) {
                return true;
            }
        });

        tracking.ColorTracker.registerColor('blue', function (r, g, b) {
            if (r < 50 && g < 50 && b > 200) {
                return true;
            }
        });

        tracking.ColorTracker.registerColor('white', function (r, g, b) {
            if (r > 240 && g > 240 && b > 240) {
                return true;
            }
        });

        tracking.ColorTracker.registerColor('grey', function (r, g, b) {
            if (r > 200 && g > 200 && b > 200) {
                return true;
            }
        });

        var tracker = new tracking.ColorTracker(["magenta", "yellow"]);

        tracking.track('#video', tracker, {camera: true});

        var movingTargetX;

        var movingTargetY;

        var festesTargetX = 400;
        var festesTargetY = 400;

        var oldDistance = 5000;


        tracker.on('track', function (event) {
                context.clearRect(0, 0, canvas.width, canvas.height);

                rahmen.strokeStyle = "#ff0000";
                rahmen.strokeRect(100, 150, 800, 550);

                ziel.strokeStyle = "#ff0000";
                ziel.fillRect(400, 400, 10, 10);

                if (event.data.length === 0) {
                    sendGetRequest("/movement/outOfBorder");
                } else {
                    event.data.forEach(function (rect) {

                        var rollBX = rect.x + rect.width / 2;
                        var rollBY = rect.y + rect.height / 2;

                        var winkelRollBToGoal = Math.atan2((movingTargetY - rollBY)/(movingTargetX - rollBX));

                        if (rect.color === "magenta") {
                            movingTargetX = rect.x + rect.width / 2;
                            movingTargetY = rect.y + rect.height / 2;
                        }

                        context.strokeStyle = rect.color;
                        context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                        context.font = '40px Helvetica';
                        //context.fillStyle = "#fff";
                        context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                        context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 40);

                        middle.fillRect(rollBX, rollBY, 10, 10);

                        var festesDX = festesTargetX - rollBX;
                        var festesDY = festesTargetY - rollBY;

                        var changingDX = movingTargetX - rollBX;
                        var changingDY = movingTargetY - rollBY;

                        var distanceToMovingObjekt = Math.sqrt(changingDX * changingDX + changingDY * changingDY);

                        var distanceToFixPoint = Math.sqrt(festesDX * festesDX + festesDY * festesDY);


                        sendGetRequest("/winkel/" + winkelRollBToGoal);

                        if (distanceToMovingObjekt > 50) {
                            if (distanceToMovingObjekt < oldDistance) {
                                sendGetRequest("/movement/forward");
                            } else if (distanceToMovingObjekt > oldDistance) {
                                sendGetRequest("/movement/rotate");
                            }
                            oldDistance = (6 * oldDistance + distanceToMovingObjekt) / 7;
                        } else {
                            sendGetRequest("/movement/stop");
                        }

                    });
                }
            }
        )
        ;
    }
    ;


    function sendGetRequest(url) {

        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function () {
        };
        xmlhttp.open("GET", url, true);
        xmlhttp.send();

    }


</script>

</body>
</html>
